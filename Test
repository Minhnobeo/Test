local success_count = 0
local total_tests = 0

print("\n=== BẮT ĐẦU KIỂM TRA EXECUTOR ===\n")

local function runTest(name, testFunc)
    total_tests = total_tests + 1
    local success, result = pcall(testFunc)
    if success and result == true then -- Kiểm tra cả success và kết quả trả về phải là true
        print("[PASS] " .. name)
        success_count = success_count + 1
    elseif success then
        print("[FAIL] " .. name .. " - Kiểm tra không đạt yêu cầu.")
    else
        print("[ERROR] " .. name .. " - Lỗi: " .. tostring(result))
    end
end

-- Test 1: Thay đổi thuộc tính Instance cơ bản (Position)
runTest("Part Position Change", function()
    local part = Instance.new("Part")
    part.Parent = game.Workspace
    part.Position = Vector3.new(0, 10, 0)
    local result = (part.Position.Y == 10)
    part:Destroy()
    return result
end)

-- Test 2: Kết nối sự kiện Touched
runTest("Event Touched Connect", function()
    local part = Instance.new("Part")
    part.Parent = game.Workspace
    local connection = part.Touched:Connect(function() end)
    local result = (connection ~= nil and typeof(connection) == "RBXScriptConnection")
    connection:Disconnect()
    part:Destroy()
    return result
end)

-- Test 3: Tạo Humanoid và đổi Health
runTest("Humanoid Health Change", function()
    local part = Instance.new("Part")
    part.Parent = game.Workspace
    local humanoid = Instance.new("Humanoid")
    humanoid.Parent = part
    humanoid.Health = 50
    local result = (humanoid.Health == 50)
    part:Destroy()
    return result
end)

-- Test 4: Truy cập Players Service
runTest("Players Service Access", function()
    local players = game:GetService("Players")
    return (players ~= nil and typeof(players) == "Players")
end)

-- Test 5: RemoteEvent FireServer (chỉ kiểm tra sự tồn tại của hàm)
runTest("RemoteEvent FireServer Function", function()
    local event = Instance.new("RemoteEvent")
    event.Parent = game.ReplicatedStorage
    local result = (typeof(event.FireServer) == "function")
    event:Destroy()
    return result
end)

-- Test 6: BindableEvent Fire
runTest("BindableEvent Fire", function()
    local event = Instance.new("BindableEvent")
    event.Parent = game.ReplicatedStorage
    local called = false
    local conn = event.Event:Connect(function() called = true end)
    event:Fire()
    wait(0.1) -- Đợi một chút để sự kiện được xử lý
    conn:Disconnect()
    event:Destroy()
    return called
end)

-- Test 7: Lighting Service và thuộc tính Brightness
runTest("Lighting Brightness Change", function()
    local lighting = game:GetService("Lighting")
    local originalBrightness = lighting.Brightness
    lighting.Brightness = 2
    local result = (lighting.Brightness == 2)
    lighting.Brightness = originalBrightness -- Khôi phục giá trị gốc
    return result
end)

-- Test 8: ReplicatedStorage Access
runTest("ReplicatedStorage Access", function()
    local rs = game:GetService("ReplicatedStorage")
    return (rs ~= nil and typeof(rs) == "ReplicatedStorage")
end)

-- Test 9: RunService Heartbeat Connect
runTest("RunService Heartbeat Connect", function()
    local runService = game:GetService("RunService")
    local connected = false
    local conn = runService.Heartbeat:Connect(function()
        connected = true
        conn:Disconnect() -- Ngắt kết nối ngay sau lần đầu tiên chạy để tránh spam
    end)
    wait(0.2) -- Đợi đủ lâu để Heartbeat có thể kích hoạt
    return connected
end)

-- Test 10: TweenService Create
runTest("TweenService Create", function()
    local tweenService = game:GetService("TweenService")
    local part = Instance.new("Part")
    part.Parent = game.Workspace
    local tweenInfo = TweenInfo.new(1)
    local tween = tweenService:Create(part, tweenInfo, {Position = Vector3.new(0, 10, 0)})
    local result = (tween ~= nil and typeof(tween) == "Tween")
    tween:Cancel() -- Đảm bảo dừng tween
    part:Destroy()
    return result
end)

-- Test 11: Debris AddItem
runTest("Debris AddItem", function()
    local debris = game:GetService("Debris")
    local part = Instance.new("Part")
    part.Parent = game.Workspace
    debris:AddItem(part, 1) -- Thêm vào Debris để tự hủy sau 1 giây
    local result = (part ~= nil) -- Kiểm tra xem có thêm được không
    return result
end)

-- Test 12: Sound Playback
runTest("Sound Playback", function()
    local sound = Instance.new("Sound")
    sound.SoundId = "rbxassetid://1837467915" -- Một âm thanh ví dụ (âm thanh mặc định của Roblox)
    sound.Parent = game.Workspace
    sound:Play()
    wait(0.1) -- Đợi một chút để âm thanh có thể bắt đầu
    local result = (sound.IsPlaying == true)
    sound:Stop()
    sound:Destroy()
    return result
end)

-- Test 13: Humanoid WalkSpeed
runTest("Humanoid WalkSpeed Change", function()
    local part = Instance.new("Part")
    part.Parent = game.Workspace
    local humanoid = Instance.new("Humanoid")
    humanoid.Parent = part
    humanoid.WalkSpeed = 25
    local result = (humanoid.WalkSpeed == 25)
    part:Destroy()
    return result
end)

-- Test 14: GuiObject Creation và hiển thị cho người chơi cục bộ
runTest("GuiObject Creation & Display", function()
    local success = false
    local playerGui = game.Players.LocalPlayer:FindFirstChildOfClass("PlayerGui")
    if playerGui then
        local screenGui = Instance.new("ScreenGui")
        screenGui.Name = "TestExecutorGui"
        screenGui.Parent = playerGui

        local textLabel = Instance.new("TextLabel")
        textLabel.Text = "Executor Test!"
        textLabel.Size = UDim2.new(0, 100, 0, 50)
        textLabel.Position = UDim2.new(0.5, -50, 0.5, -25)
        textLabel.Parent = screenGui
        
        -- Kiểm tra xem TextLabel có được tạo và gán Text đúng không
        success = (textLabel.Text == "Executor Test!" and textLabel.Parent == screenGui)
        screenGui:Destroy() -- Dọn dẹp
    end
    return success
end)

---

-- Thêm các bài kiểm tra mới:

-- Test 15: Kiểm tra các hàm toán học nâng cao của Lua
runTest("Lua Math Functions", function()
    local val1 = math.floor(3.7) == 3
    local val2 = math.ceil(3.2) == 4
    local val3 = math.abs(-5) == 5
    local val4 = math.pow(2, 3) == 8
    return val1 and val2 and val3 and val4
end)

-- Test 16: Kiểm tra thao tác với String (chuỗi)
runTest("String Manipulation", function()
    local str = "Hello World"
    local sub = string.sub(str, 1, 5) == "Hello"
    local len = string.len(str) == 11
    local lower = string.lower(str) == "hello world"
    return sub and len and lower
end)

-- Test 17: Kiểm tra thao tác với Table (bảng)
runTest("Table Manipulation", function()
    local t = {1, 2, 3}
    table.insert(t, 4)
    local insert_ok = (t[4] == 4)
    table.remove(t, 1)
    local remove_ok = (t[1] == 2)
    return insert_ok and remove_ok
end)

-- Test 18: Kiểm tra Globals (ví dụ: game, workspace, script)
runTest("Global Access", function()
    local g = (game ~= nil and typeof(game) == "Game")
    local w = (workspace ~= nil and typeof(workspace) == "Workspace")
    local s = (script ~= nil and typeof(script) == "Script")
    return g and w and s
end)

-- Test 19: Kiểm tra WaitForChild
runTest("WaitForChild", function()
    local success = false
    local folder = Instance.new("Folder")
    folder.Parent = game.Workspace
    local part = Instance.new("Part")
    part.Name = "TestPart"
    
    local childFound = false
    spawn(function() -- Sử dụng spawn để không chặn luồng chính
        local foundPart = folder:WaitForChild("TestPart", 5) -- Đợi tối đa 5 giây
        if foundPart then
            childFound = true
        end
    end)
    
    wait(0.1) -- Đợi một chút để WaitForChild bắt đầu
    part.Parent = folder -- Gán Parent sau khi WaitForChild được gọi
    wait(0.5) -- Đợi một chút để WaitForChild tìm thấy
    
    success = childFound
    folder:Destroy()
    part:Destroy()
    return success
end)

-- Test 20: Kiểm tra FindFirstChild
runTest("FindFirstChild", function()
    local part = Instance.new("Part")
    part.Name = "MyUniquePart"
    part.Parent = game.Workspace
    local found = game.Workspace:FindFirstChild("MyUniquePart") ~= nil
    part:Destroy()
    return found
end)

-- Test 21: Kiểm tra các Property của Part (Color, Material)
runTest("Part Properties (Color, Material)", function()
    local part = Instance.new("Part")
    part.Parent = game.Workspace
    part.Color = Color3.fromRGB(255, 0, 0)
    part.Material = Enum.Material.ForceField
    local result = (part.Color == Color3.fromRGB(255, 0, 0) and part.Material == Enum.Material.ForceField)
    part:Destroy()
    return result
end)

-- Test 22: Tạo WeldConstraint
runTest("WeldConstraint Creation", function()
    local part1 = Instance.new("Part")
    local part2 = Instance.new("Part")
    local weld = Instance.new("WeldConstraint")
    weld.Part0 = part1
    weld.Part1 = part2
    weld.Parent = game.Workspace
    local result = (weld.Part0 == part1 and weld.Part1 == part2)
    weld:Destroy()
    part1:Destroy()
    part2:Destroy()
    return result
end)

-- Test 23: Kiểm tra DataModel properties (ví dụ: Workspace)
runTest("DataModel Properties (Workspace)", function()
    local workspaceRef = game.Workspace
    return (workspaceRef ~= nil and typeof(workspaceRef) == "Workspace")
end)

-- Test 24: Kiểm tra khả năng tạo và phá hủy Instance trên diện rộng
runTest("Mass Instance Creation/Deletion", function()
    local success = true
    local parts = {}
    for i = 1, 50 do -- Tạo 50 Parts
        local p = Instance.new("Part")
        p.Parent = game.Workspace
        table.insert(parts, p)
    end
    wait(0.1) -- Đợi một chút
    for _, p in ipairs(parts) do
        if p.Parent ~= game.Workspace then -- Kiểm tra xem chúng còn tồn tại không
            success = false
            break
        end
        p:Destroy()
    end
    return success
end)

-- Test 25: Kiểm tra UserInputService (chỉ khả năng truy cập)
runTest("UserInputService Access", function()
    local uis = game:GetService("UserInputService")
    return (uis ~= nil and typeof(uis) == "UserInputService")
end)

-- Test 26: Kiểm tra TeleportService (chỉ khả năng truy cập)
runTest("TeleportService Access", function()
    local ts = game:GetService("TeleportService")
    return (ts ~= nil and typeof(ts) == "TeleportService")
end)

-- Test 27: Kiểm tra HttpService (chỉ khả năng truy cập)
runTest("HttpService Access", function()
    local hs = game:GetService("HttpService")
    return (hs ~= nil and typeof(hs) == "HttpService")
end)

-- Test 28: Kiểm tra CollectionService (chỉ khả năng truy cập)
runTest("CollectionService Access", function()
    local cs = game:GetService("CollectionService")
    return (cs ~= nil and typeof(cs) == "CollectionService")
end)

-- Test 29: Kiểm tra PhysicsService (chỉ khả năng truy cập)
runTest("PhysicsService Access", function()
    local ps = game:GetService("PhysicsService")
    return (ps ~= nil and typeof(ps) == "PhysicsService")
end)

-- Test 30: Kiểm tra MemoryStoreService (chỉ khả năng truy cập)
runTest("MemoryStoreService Access", function()
    local mss = game:GetService("MemoryStoreService")
    return (mss ~= nil and typeof(mss) == "MemoryStoreService")
end)


---

print("\n=== KẾT THÚC KIỂM TRA ===")
local unc_percentage = (success_count / total_tests) * 100
print(string.format("Tổng số test thành công: %d/%d (UNC: %.2f%%)", success_count, total_tests, unc_percentage))

